<!DOCTYPE html>
<?php
	include_once "connection.php";
?>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $WEB_TITLE; ?><title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"> <!-- Link to your CSS file -->
</head>

<body>
    <?php
    if (isset($_POST['sbtn'])) {  
        $qry = "select * from member_tbl where member_email='" . $_POST['eid'] . "'";
        $result = mysqli_query($conn, $qry);
        if (mysqli_num_rows($result) > 0) {
            $_SESSION['member_email'] = $_POST['eid'];
            $otp = rand(100000, 999999);
            $status = 1;
            $time = time();
            require 'PHPMailer/PHPMailerAutoload.php';
            require 'PHPMailer/class.phpmailer.php';
            $data = mysqli_fetch_array($result);
            $_SESSION['user_name_data'] = $data['member_firstname'];
            $_SESSION['random_otp'] = $otp;
            $uid = $_POST['eid'];
            $subject = "Forgot Password";
            $setfrom = "Wedding Bliss";

            // Email content
            $message = '
                <html>
                    <head>
                        <title>HTML email</title>
                        <style></style>
                    </head>
                    <body>
                        <div style="width: 60%; margin: auto; border: 1px solid #BAE3FF; border-radius: 5px; padding: 30px;">
                            <div style="text-align: center; font-size: 24px; color: #388080;">Wedding Bliss</div>
                            <div style="text-align: left; font-size: 14px; color: #383838;">
                                <p>Dear ' . $_SESSION['user_name_data'] . ',</p>
                                <p>You have requested to recover your password for online access to our website. We have generated a One-Time Passcode for you which will verify that you have requested access. This One-Time Passcode is time sensitive and valid for a single use.</p>
                                <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
                                    <span style="font-size: 20px; color: #388080; font-weight: bold;">' . $_SESSION['random_otp'] . '</span>
                                </div>
                            </div>
                            <hr>
                            <div style="font-size: 10px; text-align: center; color: #383838;">
                                <p>Thank you for utilizing our services</p>
                                <p>- Wedding Bliss</p>
                                <p>7990212140, 9723785500</p>
                                <p>www.weddingbliss2526@gmail.com</p>
                            </div>
                        </div>
                    </body>
                </html>
            ';
            $mail = new PHPMailer();
            $mail->isSMTP();
            $mail->SMTPDebug = 3;
            $mail->Host = 'smtp.gmail.com';
            $mail->SMTPSecure = "tls";
            $mail->SMTPAuth = true;
            $mail->CharSet = "UTF-8";
            $mail->Port = 587;
            $mail->Username = 'weddingbliss2526@gmail.com';
            $mail->Password = 'qxcwltabszgnzaox';
            $mail->FromName = $setfrom;
            $mail->addAddress($uid);
            $mail->Subject = $subject;
            $mail->msgHTML($message);
            if ($mail->send()) {
                $str = "insert into otp_status_tbl values(NULL, '" . $otp . "', '" . $status . "', '" . $time . "')";
                $success = mysqli_query($conn, $str);

                if ($success) {
                    header('location:verify_code.php');
                    echo "
                        <script>
                            swal({
                                title: 'Good Job',
                                text: 'OTP sent successfully. Please check your email.',
                                icon: 'success',
                            }).then(function() {
                                window.location.href = 'verify_code.php';
                            });
                        </script>";
                }
            }
        } else {
            echo "
                <script>
                    swal({
                        title: 'OOPS!',
                        text: 'Incorrect email.',
                        icon: 'error',
                    });
                </script>";
        }
    }
    ?>
    <!-- Content -->
    <div class="container">
        <div class="authentication-wrapper">
            <div class="authentication-inner">
                <!-- Forgot Password Form -->
                <div class="card">
                    <div class="card-body">
                        <div class="logo">
                            <a href="index.php" class="app-brand-link">
                                <span class="app-brand-logo">
                                    <!-- Your logo here -->
                                    <svg width="26px" height="26px" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Your SVG logo -->
                                    </svg>
                                </span>
                                <span class="app-brand-text">Wedding Bliss</span>
                            </a>
                        </div>
                        <h4>Forgot Password? ðŸ”’</h4>
                        <p>Enter your email and we'll send you instructions to reset your password.</p>
                        <form id="formAuthentication" method="POST">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="eid" placeholder="Enter your email" autofocus>
                            </div>
							<br>
                            <button type="submit" name="sbtn" class="btn btn-primary w-100">Send Reset Link</button>
                        </form>
                        <div class="text-center">
                            <a href="login.php" class="back-to-login">
                                <i class="bx bx-chevron-left"></i> Back to login
                            </a>
                        </div>
                    </div>
                </div>
                <!-- /Forgot Password -->
            </div>
        </div>
    </div>
    <!-- /Content -->

    <!-- JS libraries -->
    <script src="assets/vendor/libs/jquery/jquery.js"></script>
    <script src="assets/vendor/libs/bootstrap/bootstrap.js"></script>
    <script src="assets/vendor/libs/sweetalert/sweetalert.min.js"></script>
</body>

</html>